From 71a4825bdd170532a9462261f8809bb3d5a44ee7 Mon Sep 17 00:00:00 2001
From: Henry Schreiner <henryschreineriii@gmail.com>
Date: Wed, 18 Jan 2023 14:38:05 -0500
Subject: [PATCH] fix: conda-forge uses -DCMAKE_SYSTEM_PROCESSOR, so respect
 that too

Signed-off-by: Henry Schreiner <henryschreineriii@gmail.com>
---
 skbuild/constants.py       | 3 ++-
 skbuild/setuptools_wrap.py | 4 ++++
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/skbuild/constants.py b/skbuild/constants.py
index 85b8f5a0..a87c211d 100644
--- a/skbuild/constants.py
+++ b/skbuild/constants.py
@@ -69,7 +69,8 @@ def _default_skbuild_plat_name() -> str:
 
     # Use CMAKE_OSX_ARCHITECTURES if that is set, otherwise use ARCHFLAGS,
     # which is the variable used by Setuptools. Fall back to the machine arch
-    # if neither of those is given.
+    # if neither of those is given. Not that -D flags like CMAKE_SYSTEM_PROCESSOR
+    # will override this by setting it later.
 
     archflags = os.environ.get("ARCHFLAGS")
     if archflags is not None:
diff --git a/skbuild/setuptools_wrap.py b/skbuild/setuptools_wrap.py
index d472a9bb..0af309f4 100644
--- a/skbuild/setuptools_wrap.py
+++ b/skbuild/setuptools_wrap.py
@@ -564,6 +564,10 @@ def setup(  # noqa: C901
                 machine = cmake_arg.split("=")[1]
                 if set(machine.split(";")) == {"x86_64", "arm64"}:
                     machine = "universal2"
+            elif "CMAKE_SYSTEM_PROCESSOR" in cmake_arg:
+                machine = cmake_arg.split("=")[1]
+
+        assert machine in {"x86_64", "arm64", "universal2"}, f"macOS arch {machine} not understood"
 
         set_skbuild_plat_name(f"macosx-{version}-{machine}")
 
